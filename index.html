<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Four is Magic</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --accent: #6c9bff;
            --accent2: #a78bfa;
            --highlight: #f0c674;
            --muted: #7c8da6;
            --green: #81c995;
            --red: #e06c75;
            --bg: #1c1e26;
            --card: #232530;
            --text: #e0e4ef;
            --dim: #8892a8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            text-align: center;
            padding: 2.5rem 1rem 2rem;
            background: linear-gradient(135deg, #2a2d3a, #1c1e26);
            border-bottom: 1px solid rgba(108, 155, 255, 0.15);
        }

        header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        header h1 .four { color: var(--highlight); }

        header p {
            font-size: clamp(0.95rem, 2.5vw, 1.15rem);
            color: var(--dim);
            max-width: 560px;
            margin: 0 auto;
        }

        .container { max-width: 940px; margin: 0 auto; padding: 1rem; }

        section {
            background: var(--card);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem auto;
            border: 1px solid rgba(255,255,255,0.04);
        }

        section h2 {
            font-size: 1.5rem;
            margin-bottom: 0.8rem;
            text-align: center;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* Try It */
        .try-it h2 { color: var(--accent); }

        .input-row {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .input-row input {
            font-size: 1.3rem;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: 1.5px solid rgba(108,155,255,0.3);
            background: var(--bg);
            color: var(--text);
            width: 200px;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-row input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(108, 155, 255, 0.2);
        }

        .btn {
            font-size: 1.1rem;
            padding: 0.6rem 1.4rem;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: #1c1e26;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.12s, opacity 0.12s;
        }

        .btn:hover { transform: scale(1.03); opacity: 0.9; }

        .error-msg {
            text-align: center;
            color: var(--red);
            font-size: 0.9rem;
            min-height: 1.4em;
            margin-bottom: 0.5rem;
        }

        #chain-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            justify-content: center;
            align-items: center;
            min-height: 50px;
            padding: 0.8rem;
        }

        .chain-step {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            animation: fadeIn 0.35s ease-out both;
        }

        .chain-number {
            font-size: 1.3rem;
            font-weight: 600;
            padding: 0.35rem 0.7rem;
            border-radius: 8px;
            background: var(--bg);
            border: 1.5px solid rgba(108,155,255,0.2);
            text-align: center;
        }

        .chain-number.is-four {
            border-color: var(--highlight);
            background: rgba(240, 198, 116, 0.1);
            color: var(--highlight);
            font-size: 1.5rem;
            animation: fadeIn 0.35s ease-out, glow 1.5s ease-in-out infinite alternate;
        }

        .chain-word {
            font-size: 0.78rem;
            color: var(--muted);
            display: block;
            margin-top: 1px;
        }

        .chain-arrow { font-size: 1.2rem; color: var(--dim); }

        #chain-explanation {
            font-size: 0.9rem;
            margin-top: 1rem;
            line-height: 1.7;
            text-align: left;
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            display: none;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .word-highlight { color: var(--green); font-weight: 600; }
        .count-highlight { color: var(--accent); font-weight: 600; }
        .four-line { color: var(--highlight); font-weight: 600; font-size: 1rem; margin-top: 0.5rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glow {
            from { box-shadow: 0 0 4px rgba(240, 198, 116, 0.2); }
            to { box-shadow: 0 0 14px rgba(240, 198, 116, 0.4); }
        }

        .confetti-piece {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            animation: confettiFall 2s ease-in forwards;
        }

        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
        }

        /* Flow Graph */
        .flow-section h2 { color: var(--accent2); }
        .flow-section .subtitle {
            text-align: center;
            color: var(--dim);
            margin-bottom: 1.2rem;
            font-size: 0.95rem;
        }

        .range-controls {
            display: flex;
            gap: 0.6rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .range-controls label {
            font-size: 0.95rem;
            color: var(--dim);
        }

        .range-controls input[type="text"] {
            font-size: 1rem;
            padding: 0.35rem 0.5rem;
            border-radius: 6px;
            border: 1.5px solid rgba(167,139,250,0.3);
            background: var(--bg);
            color: var(--text);
            width: 85px;
            text-align: center;
            outline: none;
        }

        .range-controls input[type="text"]:focus {
            border-color: var(--accent2);
        }

        .range-controls .btn {
            font-size: 0.95rem;
            padding: 0.4rem 1rem;
            background: var(--accent2);
        }

        .range-error {
            text-align: center;
            color: var(--red);
            font-size: 0.9rem;
            min-height: 1.4em;
            margin-bottom: 0.5rem;
        }

        #flow-container { width: 100%; }
        #flow-container svg { display: block; margin: 0 auto; }

        .flow-node circle {
            stroke-width: 1.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .flow-node text {
            fill: white;
            font-weight: 600;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
        }

        /* Why */
        .why-section h2 { color: var(--green); }

        .why-section p, .why-section li {
            font-size: 1rem;
            line-height: 1.7;
            margin-bottom: 0.7rem;
            color: var(--text);
        }

        .why-section ul { padding-left: 1.5rem; margin-bottom: 0.8rem; }

        .key-insight {
            background: rgba(108,155,255,0.06);
            border-left: 3px solid var(--accent);
            padding: 0.9rem 1.1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        /* Transition Table */
        .table-section h2 { color: var(--accent); }
        .table-section .subtitle {
            text-align: center;
            color: var(--dim);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .table-tabs {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .table-tab {
            padding: 0.4rem 1rem;
            border-radius: 6px;
            border: 1.5px solid rgba(108,155,255,0.2);
            background: transparent;
            color: var(--dim);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.15s;
        }

        .table-tab.active {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
            font-weight: 600;
        }

        .table-tab:hover:not(.active) {
            border-color: var(--accent);
            color: var(--text);
        }

        .table-wrap {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .table-wrap table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .table-wrap thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table-wrap th {
            background: var(--bg);
            padding: 0.6rem 0.8rem;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            border-bottom: 1.5px solid rgba(108,155,255,0.2);
            white-space: nowrap;
        }

        .table-wrap th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .table-wrap th.sortable:hover {
            color: var(--highlight);
        }

        .table-wrap th .sort-arrow {
            margin-left: 0.3rem;
            font-size: 0.75rem;
        }

        .table-wrap td {
            padding: 0.45rem 0.8rem;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text);
        }

        .table-wrap tbody tr:hover {
            background: rgba(108,155,255,0.05);
        }

        .table-wrap .num-cell { font-weight: 600; }
        .table-wrap .word-cell { color: var(--muted); }
        .table-wrap .chain-cell { color: var(--dim); font-size: 0.85rem; }
        .table-wrap .pct-bar {
            display: inline-block;
            height: 14px;
            border-radius: 3px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--dim);
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            section { padding: 1.2rem; margin: 1rem; }
            .range-controls { gap: 0.4rem; }
            .range-controls input[type="text"] { width: 65px; }
        }
    </style>
</head>
<body>

<header>
    <h1><span class="four">Four</span> is Magic</h1>
    <p>Pick any number. Count the letters in its name. Repeat. You always end up at four.</p>
</header>

<div class="container">

    <!-- Try It -->
    <section class="try-it">
        <h2>Try a Number</h2>
        <div class="input-row">
            <input type="text" id="number-input" placeholder="Enter a number" inputmode="numeric">
            <button class="btn" id="go-btn">Go</button>
        </div>
        <div class="error-msg" id="try-error"></div>
        <div id="chain-display"></div>
        <div id="chain-explanation"></div>
    </section>

    <!-- Flow Graph -->
    <section class="flow-section">
        <h2>Where Numbers Go</h2>
        <p class="subtitle">Each bubble is a number. Arrows show where it goes when you count its letters. Thicker arrows mean more numbers take that path. Everything ends at 4.</p>
        <div class="range-controls">
            <label>Show numbers</label>
            <input type="text" id="range-min" value="0" inputmode="numeric">
            <label>to</label>
            <input type="text" id="range-max" value="20" inputmode="numeric">
            <button class="btn" id="range-go-btn">Draw</button>
        </div>
        <div class="range-error" id="range-error"></div>
        <div id="flow-container"></div>
    </section>

    <!-- Transition Table -->
    <section class="table-section">
        <h2>The Transition Table</h2>
        <p class="subtitle">For each number in your range: spell it, count the letters, and see where it lands.</p>
        <div class="table-tabs" id="table-tabs">
            <button class="table-tab active" data-view="summary">Summary</button>
            <button class="table-tab" data-view="detail">Every Number</button>
        </div>
        <div class="table-wrap" id="table-container"></div>
    </section>

    <!-- Why -->
    <section class="why-section">
        <h2>Why Does This Always Work?</h2>

        <p>Here's the secret: when you spell out any number, the number of letters is almost always <em>less</em> than the number you started with.</p>

        <div class="key-insight">
            <strong>The key idea:</strong> Spell out any number bigger than 4 and count its letters. You always get a smaller number than what you started with. Since the numbers keep getting smaller, they can't bounce around forever — they have to land somewhere. And that somewhere is always 4.
        </div>

        <p>Look at how fast numbers shrink:</p>
        <ul>
            <li><strong>"seven"</strong> has 5 letters — already smaller than 7</li>
            <li><strong>"one thousand"</strong> has 11 letters — way smaller than 1,000</li>
            <li><strong>"one million"</strong> has 10 letters — massively smaller than 1,000,000</li>
        </ul>

        <p>So no matter how big you start, after just one or two steps you're down to a small number. And once you're in the small numbers (say, under 20), there are only a few possible paths — and they all lead to 4.</p>

        <div class="key-insight">
            <strong>Why 4 and not some other number?</strong> "Four" has exactly 4 letters. It's the only number in English where the letter count matches the number. In math, this is called an <strong>absorbing state</strong> — a place you can reach but can never leave. Every chain gets pulled down to small numbers, and 4 is the only small number that maps to itself, so everything ends up there.
        </div>

        <p>Try setting the range above to something big, like 1 to 1000. You'll see that even a thousand different starting numbers all funnel through the same handful of small numbers on the way down to 4.</p>
    </section>

</div>

<footer>Made with math</footer>

<script>
// ============================================================
// Number-to-words (up to 999,999,999)
// ============================================================
var ONES = ['','one','two','three','four','five','six','seven','eight','nine',
            'ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen',
            'seventeen','eighteen','nineteen'];
var TENS = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];

function numberToWords(n) {
    if (n === 0) return 'zero';
    var w = '';
    if (n >= 1000000000000) { w += numberToWords(Math.floor(n / 1000000000000)) + ' trillion '; n %= 1000000000000; }
    if (n >= 1000000000) { w += numberToWords(Math.floor(n / 1000000000)) + ' billion '; n %= 1000000000; }
    if (n >= 1000000) { w += numberToWords(Math.floor(n / 1000000)) + ' million '; n %= 1000000; }
    if (n >= 1000) { w += numberToWords(Math.floor(n / 1000)) + ' thousand '; n %= 1000; }
    if (n >= 100) { w += ONES[Math.floor(n / 100)] + ' hundred '; n %= 100; }
    if (n >= 20) { w += TENS[Math.floor(n / 10)] + ' '; n %= 10; }
    if (n > 0) { w += ONES[n] + ' '; }
    return w.trim();
}

// Max we can handle accurately in JS integer math
var MAX_NUMBER = 999999999999999; // ~1 quadrillion

function countLetters(word) { return word.replace(/[^a-z]/g, '').length; }

function nextNumber(n) { return countLetters(numberToWords(n)); }

function getChain(n) {
    var chain = [n];
    var cur = n, safety = 200;
    while (cur !== 4 && safety-- > 0) {
        cur = nextNumber(cur);
        chain.push(cur);
    }
    return chain;
}

// ============================================================
// Validation helpers
// ============================================================
function parseNonNegInt(str) {
    str = str.trim();
    if (str === '') return { ok: false, msg: 'Enter a number.' };
    if (!/^\d+$/.test(str)) return { ok: false, msg: '"' + str + '" is not a whole number (0, 1, 2, 3...).' };
    var n = parseInt(str, 10);
    if (isNaN(n)) return { ok: false, msg: '"' + str + '" is not a valid number.' };
    return { ok: true, value: n };
}

// ============================================================
// Try It — interactive chain
// ============================================================
document.getElementById('go-btn').addEventListener('click', runChain);
document.getElementById('number-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') runChain();
});

function runChain() {
    var input = document.getElementById('number-input');
    var errorEl = document.getElementById('try-error');
    var display = document.getElementById('chain-display');
    var explanation = document.getElementById('chain-explanation');

    display.textContent = '';
    explanation.textContent = '';
    explanation.style.display = 'none';

    var parsed = parseNonNegInt(input.value);
    if (!parsed.ok) {
        errorEl.textContent = parsed.msg;
        return;
    }
    if (parsed.value > MAX_NUMBER) {
        errorEl.textContent = 'That\'s too big. Try something under ' + MAX_NUMBER.toLocaleString() + '.';
        return;
    }
    errorEl.textContent = '';

    var chain = getChain(parsed.value);

    chain.forEach(function(num, i) {
        setTimeout(function() {
            if (i > 0) {
                var arrow = document.createElement('span');
                arrow.className = 'chain-arrow';
                arrow.textContent = '\u2192';
                display.appendChild(arrow);
            }

            var step = document.createElement('span');
            step.className = 'chain-step';

            var numEl = document.createElement('span');
            numEl.className = 'chain-number' + (num === 4 ? ' is-four' : '');
            numEl.appendChild(document.createTextNode(num.toLocaleString()));

            var wordEl = document.createElement('span');
            wordEl.className = 'chain-word';
            wordEl.textContent = numberToWords(num);
            numEl.appendChild(wordEl);

            step.appendChild(numEl);
            display.appendChild(step);

            if (i === chain.length - 1) {
                showExplanation(chain);
                launchConfetti();
            }
        }, i * 450);
    });
}

function showExplanation(chain) {
    var el = document.getElementById('chain-explanation');
    el.textContent = '';

    for (var i = 0; i < chain.length - 1; i++) {
        var word = numberToWords(chain[i]);
        var letters = countLetters(word);

        var line = document.createElement('div');

        var bold = document.createElement('strong');
        bold.textContent = chain[i].toLocaleString();
        line.appendChild(bold);
        line.appendChild(document.createTextNode(' \u2192 '));

        var wSpan = document.createElement('span');
        wSpan.className = 'word-highlight';
        wSpan.textContent = '"' + word + '"';
        line.appendChild(wSpan);

        line.appendChild(document.createTextNode(' has '));

        var cSpan = document.createElement('span');
        cSpan.className = 'count-highlight';
        cSpan.textContent = letters + ' letter' + (letters !== 1 ? 's' : '');
        line.appendChild(cSpan);

        el.appendChild(line);
    }

    var fourLine = document.createElement('div');
    fourLine.className = 'four-line';
    fourLine.textContent = '4 \u2192 "four" has 4 letters.';
    el.appendChild(fourLine);

    el.style.display = 'block';
}

function launchConfetti() {
    var colors = ['#6c9bff','#a78bfa','#f0c674','#81c995','#e06c75','#d4a0ff'];
    for (var i = 0; i < 30; i++) {
        var p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.left = Math.random() * 100 + 'vw';
        p.style.top = '-10px';
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.animationDelay = Math.random() * 0.5 + 's';
        p.style.animationDuration = (1.5 + Math.random()) + 's';
        p.style.width = (5 + Math.random() * 7) + 'px';
        p.style.height = (5 + Math.random() * 7) + 'px';
        p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        document.body.appendChild(p);
        setTimeout(function() { p.remove(); }, 3000);
    }
}

// ============================================================
// Flow Graph
// ============================================================
document.getElementById('range-go-btn').addEventListener('click', function() { drawFlowGraph(); });
document.getElementById('range-min').addEventListener('keydown', function(e) { if (e.key === 'Enter') drawFlowGraph(); });
document.getElementById('range-max').addEventListener('keydown', function(e) { if (e.key === 'Enter') drawFlowGraph(); });

function drawFlowGraph() {
    var container = document.getElementById('flow-container');
    var errorEl = document.getElementById('range-error');
    container.textContent = '';
    errorEl.textContent = '';

    var parsedMin = parseNonNegInt(document.getElementById('range-min').value);
    var parsedMax = parseNonNegInt(document.getElementById('range-max').value);

    if (!parsedMin.ok) { errorEl.textContent = 'Min: ' + parsedMin.msg; return; }
    if (!parsedMax.ok) { errorEl.textContent = 'Max: ' + parsedMax.msg; return; }

    var rangeMin = parsedMin.value;
    var rangeMax = parsedMax.value;

    if (rangeMin > rangeMax) {
        errorEl.textContent = 'Min (' + rangeMin.toLocaleString() + ') must be \u2264 max (' + rangeMax.toLocaleString() + ').';
        return;
    }
    if (rangeMax > MAX_NUMBER) {
        errorEl.textContent = 'Max is too big. Keep it under ' + MAX_NUMBER.toLocaleString() + '.';
        return;
    }
    if (rangeMax - rangeMin > 100000) {
        errorEl.textContent = 'Range is too wide. Keep it under 100,000 numbers.';
        return;
    }

    // Also update the transition table
    drawTable(rangeMin, rangeMax);

    var rangeSize = rangeMax - rangeMin + 1;

    // For large ranges (>60 numbers), only show the "highway" nodes:
    // the small intermediate values everything passes through.
    // For small ranges, show every number as its own node.
    var SMALL_THRESHOLD = 60;
    // After one step, all numbers map to a value roughly <= 30.
    // So the highway is just numbers <= some small cap.
    var HIGHWAY_CAP = 30;
    var compactMode = rangeSize > SMALL_THRESHOLD;

    var edgeWeights = {};
    var nodeTraffic = {};
    var showNodes = new Set();

    for (var i = rangeMin; i <= rangeMax; i++) {
        var chain = getChain(i);
        for (var j = 0; j < chain.length; j++) {
            var v = chain[j];
            // In compact mode, only track nodes <= HIGHWAY_CAP
            if (!compactMode || v <= HIGHWAY_CAP) {
                nodeTraffic[v] = (nodeTraffic[v] || 0) + 1;
                showNodes.add(v);
            }
            if (j < chain.length - 1 && chain[j] !== chain[j + 1]) {
                var from = chain[j];
                var to = chain[j + 1];
                // In compact mode, only track edges between small nodes
                if (!compactMode || (from <= HIGHWAY_CAP && to <= HIGHWAY_CAP)) {
                    var key = from + '->' + to;
                    edgeWeights[key] = (edgeWeights[key] || 0) + 1;
                }
            }
        }
    }

    if (!compactMode) {
        // In full mode, collect all nodes from all chains
        for (var i = rangeMin; i <= rangeMax; i++) {
            getChain(i).forEach(function(v) { showNodes.add(v); });
        }
    }

    var nodes = [];
    showNodes.forEach(function(n) {
        nodes.push({ id: n, traffic: nodeTraffic[n] || 0, word: numberToWords(n) });
    });

    var edges = [];
    for (var key in edgeWeights) {
        var parts = key.split('->');
        edges.push({ source: parseInt(parts[0]), target: parseInt(parts[1]), weight: edgeWeights[key] });
    }

    // Show a summary note for compact mode
    if (compactMode) {
        var note = document.createElement('p');
        note.style.textAlign = 'center';
        note.style.color = '#8892a8';
        note.style.fontSize = '0.9rem';
        note.style.marginBottom = '0.8rem';
        note.textContent = 'With ' + rangeSize.toLocaleString() + ' starting numbers, '
            + 'these are the ' + nodes.length + ' in-between numbers they all pass through on the way to 4. '
            + 'Bigger bubbles = more numbers flowing through. Hover for details.';
        container.appendChild(note);
    }

    var nodeCount = nodes.length;
    var width = Math.min(container.clientWidth || 900, 900);
    var height = Math.max(450, Math.min(nodeCount * 22, 650));
    var pad = 45;

    var svg = d3.select(container).append('svg')
        .attr('width', width)
        .attr('height', height);

    svg.append('defs').append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 18)
        .attr('refY', 0)
        .attr('markerWidth', 5)
        .attr('markerHeight', 5)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-4L8,0L0,4')
        .attr('fill', '#556');

    var maxWeight = d3.max(edges, function(d) { return d.weight; }) || 1;
    var linkWidthScale = d3.scaleLinear().domain([1, maxWeight]).range([1.5, Math.min(12, 2 + maxWeight * 0.5)]);
    var linkOpacityScale = d3.scaleLinear().domain([1, maxWeight]).range([0.25, 0.8]);

    var maxTraffic = d3.max(nodes, function(d) { return d.traffic; }) || 1;
    var maxR = nodeCount > 40 ? 20 : 26;
    var minR = nodeCount > 40 ? 8 : 10;
    var radiusScale = d3.scaleSqrt().domain([1, maxTraffic]).range([minR, maxR]);

    var palette = ['#f0c674','#81c995','#6c9bff','#a78bfa','#e06c75','#d4a0ff'];
    function nodeColor(n) {
        if (n === 4) return '#f0c674';
        var steps = getChain(n).length - 1;
        return palette[Math.min(steps, palette.length - 1)];
    }

    var chargeStrength = nodeCount > 40 ? -150 : -280;
    var linkDist = nodeCount > 40 ? 45 : 65;

    var simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(edges).id(function(d) { return d.id; }).distance(linkDist))
        .force('charge', d3.forceManyBody().strength(chargeStrength))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(function(d) { return radiusScale(d.traffic) + 4; }))
        .force('x', d3.forceX(width / 2).strength(0.07))
        .force('y', d3.forceY(height / 2).strength(0.07));

    var link = svg.append('g').selectAll('line')
        .data(edges)
        .join('line')
        .attr('stroke', '#556')
        .attr('stroke-width', function(d) { return linkWidthScale(d.weight); })
        .attr('stroke-opacity', function(d) { return linkOpacityScale(d.weight); })
        .attr('marker-end', 'url(#arrow)');

    var node = svg.append('g').selectAll('g')
        .data(nodes)
        .join('g')
        .attr('class', 'flow-node')
        .call(d3.drag()
            .on('start', function(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            })
            .on('drag', function(event, d) { d.fx = event.x; d.fy = event.y; })
            .on('end', function(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }));

    node.append('circle')
        .attr('r', function(d) { return radiusScale(d.traffic); })
        .attr('fill', function(d) { return nodeColor(d.id); })
        .attr('stroke', function(d) { return d.id === 4 ? '#fff' : 'rgba(255,255,255,0.15)'; })
        .attr('stroke-width', function(d) { return d.id === 4 ? 2.5 : 1; })
        .attr('opacity', 0.9);

    // Always show labels — nodeCount is capped to ~30 in compact mode
    node.append('text')
        .text(function(d) { return d.id; })
        .attr('font-size', function(d) {
            if (d.id === 4) return '14px';
            return nodeCount > 40 ? '9px' : '11px';
        });

    node.append('title')
        .text(function(d) {
            var line1 = d.id + ' ("' + d.word + '")';
            var line2 = d.traffic.toLocaleString() + ' number' + (d.traffic !== 1 ? 's' : '') + ' pass through here';
            var line3 = getChain(d.id).join(' \u2192 ');
            return line1 + '\n' + line2 + '\n' + line3;
        });

    simulation.on('tick', function() {
        nodes.forEach(function(d) {
            var r = radiusScale(d.traffic);
            d.x = Math.max(pad + r, Math.min(width - pad - r, d.x));
            d.y = Math.max(pad + r, Math.min(height - pad - r, d.y));
        });

        link
            .attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });
        node.attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
    });
}

// ============================================================
// Transition Table
// ============================================================
var currentTableView = 'summary';
var lastTableMin = 0;
var lastTableMax = 20;

// Tab switching
document.getElementById('table-tabs').addEventListener('click', function(e) {
    var tab = e.target.closest('.table-tab');
    if (!tab) return;
    var view = tab.getAttribute('data-view');
    if (view === currentTableView) return;
    currentTableView = view;
    var tabs = document.querySelectorAll('.table-tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].className = 'table-tab' + (tabs[i].getAttribute('data-view') === view ? ' active' : '');
    }
    drawTable(lastTableMin, lastTableMax);
});

function drawTable(rangeMin, rangeMax) {
    lastTableMin = rangeMin;
    lastTableMax = rangeMax;
    var container = document.getElementById('table-container');
    container.textContent = '';

    if (currentTableView === 'summary') {
        drawSummaryTable(container, rangeMin, rangeMax);
    } else {
        drawDetailTable(container, rangeMin, rangeMax);
    }
}

function drawSummaryTable(container, rangeMin, rangeMax) {
    // For each possible "maps to" value, count how many numbers in the range
    // map to it on their first step
    var firstStep = {};
    for (var i = rangeMin; i <= rangeMax; i++) {
        var target = nextNumber(i);
        firstStep[target] = (firstStep[target] || 0) + 1;
    }

    var rangeSize = rangeMax - rangeMin + 1;
    var rows = Object.keys(firstStep).map(function(k) {
        return { target: parseInt(k), count: firstStep[k] };
    }).sort(function(a, b) { return b.count - a.count; });

    var maxCount = rows.length > 0 ? rows[0].count : 1;

    var table = document.createElement('table');
    var thead = document.createElement('thead');
    var hrow = document.createElement('tr');
    ['Maps To', 'Spelled', 'Count', 'Share', ''].forEach(function(text) {
        var th = document.createElement('th');
        th.textContent = text;
        hrow.appendChild(th);
    });
    thead.appendChild(hrow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    rows.forEach(function(row) {
        var tr = document.createElement('tr');
        var pct = (row.count / rangeSize * 100);

        var tdNum = document.createElement('td');
        tdNum.className = 'num-cell';
        tdNum.textContent = row.target;
        tr.appendChild(tdNum);

        var tdWord = document.createElement('td');
        tdWord.className = 'word-cell';
        tdWord.textContent = numberToWords(row.target);
        tr.appendChild(tdWord);

        var tdCount = document.createElement('td');
        tdCount.textContent = row.count.toLocaleString();
        tr.appendChild(tdCount);

        var tdPct = document.createElement('td');
        tdPct.textContent = pct.toFixed(1) + '%';
        tr.appendChild(tdPct);

        var tdBar = document.createElement('td');
        var bar = document.createElement('span');
        bar.className = 'pct-bar';
        bar.style.width = Math.max(2, row.count / maxCount * 120) + 'px';
        var palette = ['#f0c674','#81c995','#6c9bff','#a78bfa','#e06c75','#d4a0ff'];
        var steps = getChain(row.target).length - 1;
        bar.style.background = row.target === 4 ? '#f0c674' : palette[Math.min(steps, palette.length - 1)];
        bar.style.opacity = '0.7';
        tdBar.appendChild(bar);
        tr.appendChild(tdBar);

        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
}

var detailSortCol = 0;
var detailSortAsc = true;

function drawDetailTable(container, rangeMin, rangeMax) {
    var rangeSize = rangeMax - rangeMin + 1;

    // Cap the detail table at 5000 rows for performance
    if (rangeSize > 5000) {
        var note = document.createElement('p');
        note.style.padding = '1rem';
        note.style.color = '#8892a8';
        note.style.textAlign = 'center';
        note.textContent = 'Detail view is limited to ranges of 5,000 or fewer. Your range has ' + rangeSize.toLocaleString() + ' numbers. Try the summary view, or narrow the range.';
        container.appendChild(note);
        return;
    }

    var data = [];
    for (var i = rangeMin; i <= rangeMax; i++) {
        var chain = getChain(i);
        data.push({ num: i, word: numberToWords(i), letters: nextNumber(i), chain: chain, steps: chain.length - 1 });
    }

    var headers = [
        { text: 'Number', key: 'num' },
        { text: 'Spelled Out', key: 'word' },
        { text: 'Letters', key: 'letters' },
        { text: 'Steps to 4', key: 'steps' },
        { text: 'Full Chain', key: null }
    ];

    function renderTable() {
        container.textContent = '';

        // Sort
        var sorted = data.slice();
        var col = headers[detailSortCol];
        if (col.key) {
            sorted.sort(function(a, b) {
                var va = a[col.key], vb = b[col.key];
                if (typeof va === 'string') {
                    var cmp = va.localeCompare(vb);
                    return detailSortAsc ? cmp : -cmp;
                }
                return detailSortAsc ? va - vb : vb - va;
            });
        }

        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var hrow = document.createElement('tr');
        headers.forEach(function(h, idx) {
            var th = document.createElement('th');
            if (h.key) {
                th.className = 'sortable';
                th.addEventListener('click', function() {
                    if (detailSortCol === idx) { detailSortAsc = !detailSortAsc; }
                    else { detailSortCol = idx; detailSortAsc = true; }
                    renderTable();
                });
            }
            th.appendChild(document.createTextNode(h.text));
            if (h.key) {
                var arrow = document.createElement('span');
                arrow.className = 'sort-arrow';
                arrow.textContent = detailSortCol === idx ? (detailSortAsc ? ' \u25B2' : ' \u25BC') : ' \u25BD';
                th.appendChild(arrow);
            }
            hrow.appendChild(th);
        });
        thead.appendChild(hrow);
        table.appendChild(thead);

        var tbody = document.createElement('tbody');
        sorted.forEach(function(row) {
            var tr = document.createElement('tr');

            var tdNum = document.createElement('td');
            tdNum.className = 'num-cell';
            tdNum.textContent = row.num.toLocaleString();
            tr.appendChild(tdNum);

            var tdWord = document.createElement('td');
            tdWord.className = 'word-cell';
            tdWord.textContent = row.word;
            tr.appendChild(tdWord);

            var tdLetters = document.createElement('td');
            tdLetters.textContent = row.letters;
            tr.appendChild(tdLetters);

            var tdSteps = document.createElement('td');
            tdSteps.textContent = row.steps;
            tr.appendChild(tdSteps);

            var tdChain = document.createElement('td');
            tdChain.className = 'chain-cell';
            tdChain.textContent = row.chain.join(' \u2192 ');
            tr.appendChild(tdChain);

            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    renderTable();
}

// ============================================================
// Init
// ============================================================
drawFlowGraph();
</script>

</body>
</html>
